# 四层，七层负载均衡的区别

```
所谓四层就是基于IP + 端口的负载均衡：
七层就是基于url等应用层信息的负载均衡
```

二层负载均衡会通过一个虚拟MAC地址接收请求，然后再分配到真实的MAC地址

三层负载均衡会通过一个虚拟IP地址的接收请求，然后再分配到真实IP地址

四层通过虚拟IP+端口接收请求，然后再分配到真实服务器

七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器


第四层的负载均衡，就是通过发布三层的IP地址(vip)，然后加四层的端口，来决定哪些流量需要做负载均衡，对需要处理的流量进行nat处理，转至后台服务器，并记录这个tcp或者udp的流量是由哪台服务器处理的，后续这个连接的所有的流量都同样转发到同一台服务器处理

负载均衡通常称为四层交换机或七层交换机。
四层交换机主要分析IP层及tcp/udp层，实现四层流量负载均衡

七层交换机除了支持四层负载均衡以外，还有分析应用层的信息如http协议url和cookie信息

负载均衡分为L4 Switch(四层交换)，即OSI第4层工作，就是TCP层
此种Load Balancer不理解应用协议（如HTTP/FTP/MYSQL等等）如:LVS F5

另一种叫做L7 Switch（七层交换），OSI的最高层，应用层
这种Load Balancer能理解应用协议。 HAProxy, Mysql proxy

四层负载均衡本质是转发，而七层负载的本质内容就是交换和代理

## 技术原理上的区别

所谓四层负载均衡，也就是主要通过报文中的目标地址和端口，再加上负载均衡设置的服务选择方式，决定最终选择的内部服务器

以常见的TCP为例，负载均衡设备接收到第一个来自客户端SYN请求时，即通过上述方式选择一个最佳的服务器，并对报文中的目标IP地址进行修改(改为后端服务器IP)，直接转发给服务器。tcp的连接建立，即三次握手是客户端和服务器直接建立的，负载均衡设备只是做一个类似路由器的转发动作

## 负载均衡的算法

`轮询`

将所有的请求依次分发到每台服务器上,适合服务器硬件配置相同的场景。

优点: 每台服务器的请求数目相同
缺点: 服务器压力不一样，不适合服务器配置不通的情况

`随机`

请求随机分配到各个服务器

优点： 使用简单
缺点： 不适合机器配置不同的场景

`最少连接`

将请求分配到连接数最少的服务器

优点： 根据服务器当前的请求处理情况，动态分配
缺点： 算法实现相对复杂，需要监控服务器请求连接数

`hash`

根据Ip地址进行hash计算，得到ip地址

优点： 将来自同一ip地址的请求，同一会话期内，转发到相同的服务器；实现会话粘贴。
缺点： 目标服务器宕机后，会话会丢失


`加权`

在轮训，随机，最少连接，hash等算法的基础上，通过加权的方式，进行负载均衡

优点： 根据权重，调节转发到后端服务器de 请求数
缺点:	使用相对复杂